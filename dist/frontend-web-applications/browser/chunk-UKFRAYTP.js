import{Fa as u,Oa as b,Pa as h,Q as n,Qa as p,Yb as O,_b as D,a as S,b as I,fc as P,gb as C,gc as T,hc as E,ic as w,jc as R,kc as x,lc as M,mc as F,nc as $,oa as A,oc as k,pc as N,qc as G,wa as g}from"./chunk-XBBXNFZM.js";var f=class a{psychologistId;calendarOptions={plugins:[F,$],initialView:"timeGridWeek",selectable:!0,slotDuration:"00:30:00",headerToolbar:{left:"prev,next today",center:"title",right:"timeGridWeek,timeGridDay"},events:[],select:this.handleDateSelect.bind(this)};timeSlotApi=n(x);reservationApi=n(G);appointmentApi=n(R);paymentApi=n(M);router=n(D);psychologistApi=n(P);patientApi=n(T);psychologistSpecialization="";timeSlots=[];ngOnInit(){this.loadAppointments(),this.loadPsychologistDetails(),this.loadTimeSlots()}loadPsychologistDetails(){this.psychologistId&&this.psychologistApi.getById(this.psychologistId).subscribe({next:e=>{console.log("Psychologist details fetched:",e),this.psychologistSpecialization=e.specialization},error:e=>console.error("Error fetching psychologist details:",e)})}loadTimeSlots(){this.timeSlotApi.getAll().subscribe({next:e=>{console.log("All TimeSlots (raw):",e),e.length>0&&(console.log("First TimeSlot structure:",e[0]),console.log("Current Psychologist ID:",this.psychologistId)),this.timeSlots=e;let t=this.timeSlots.map(o=>({title:"Available",start:o.startTime,end:o.endTime,display:"background",color:"#00cc00"}));console.log("Generated Events:",t),this.calendarOptions=I(S({},this.calendarOptions),{events:[...(this.calendarOptions.events||[]).filter(o=>o.display!=="background"),...t]})},error:e=>console.error("Error fetching TimeSlots:",e)})}loadAppointments(){this.psychologistId&&this.appointmentApi.getAll().subscribe(e=>{let o=w.toEntitiesFromResponse(e).filter(s=>s.provider.id===this.psychologistId).map(s=>({title:"Occupied",start:s.timeSlot.startTime,end:s.timeSlot.endTime,color:"#ff9f89"}));this.calendarOptions=I(S({},this.calendarOptions),{events:[...(this.calendarOptions.events||[]).filter(s=>s.display==="background"),...o]})})}handleDateSelect(e){let t=new Date(e.start),o=new Date(e.end);if(console.log("Selection Start:",t.toISOString()),console.log("Selection End:",o.toISOString()),t<new Date){alert("Cannot create a reservation in the past. Please select a future date.");return}let v=this.timeSlots.find(r=>{let l=new Date(r.startTime),m=new Date(r.endTime),c=Math.abs(l.getTime()-t.getTime()),i=Math.abs(m.getTime()-o.getTime());return c<1e3?(console.log(`Found potential match slot ${r.id}:`),console.log(`  Slot Start: ${l.toISOString()}`),console.log(`  Sel Start : ${t.toISOString()}`),console.log(`  Slot End  : ${m.toISOString()}`),console.log(`  Sel End   : ${o.toISOString()}`),console.log(`  Start Diff: ${c}ms`),console.log(`  End Diff  : ${i}ms`),i>=1e3&&console.warn(`Slot ${r.id} end time mismatch. Ignoring end time for match.`),!0):!1});if(!v){console.warn("No matching slot found for selection."),alert("Please select an available (green) time slot.");return}if(!confirm(`Book reservation from ${t.toLocaleTimeString()} to ${o.toLocaleTimeString()}?`))return;let d=Number(localStorage.getItem("clientId"))||0;console.log("Current User ID from localStorage:",d),this.patientApi.getAll().subscribe({next:r=>{console.log("All patients fetched from API:",r);let l=r.find(i=>!!(i.user&&i.user.id===d||i.userId===d||i.user_id===d));if(!l){alert("Patient profile not found for current user.");return}let m=l.id;console.log("Using existing TimeSlot:",v);let c={totalAmount:{amount:100,currency:"USD"},status:"AUTHORIZED"};console.log("Sending Payment Payload:",c),this.paymentApi.post(c).subscribe({next:i=>{console.log("Payment created:",i);let y={patientId:m,psycologistId:this.psychologistId,timeSlotId:v.id,paymentId:i.id};console.log("Sending Reservation Payload:",y),this.reservationApi.post(y).subscribe({next:()=>{alert("Reservation created successfully!"),this.loadAppointments(),this.loadTimeSlots(),this.router.navigate(["/client/appointment"])},error:_=>{console.error("Error creating reservation:",_),alert("Failed to create reservation.")}})},error:i=>{console.error("Error creating payment:",i),alert("Failed to create payment.")}})},error:r=>{console.error("Error fetching patients:",r),alert("Failed to verify patient identity.")}})}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=g({type:a,selectors:[["app-reservation-calendar"]],inputs:{psychologistId:"psychologistId"},decls:1,vars:1,consts:[[3,"options"]],template:function(t,o){t&1&&p(0,"full-calendar",0),t&2&&u("options",o.calendarOptions)},dependencies:[N,k],encapsulation:2})};var U=class a{psychologistId;route=n(O);ngOnInit(){this.route.paramMap.subscribe(e=>{this.psychologistId=Number(e.get("psychologistId"))})}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=g({type:a,selectors:[["app-schedule-reservation"]],decls:7,vars:1,consts:[[1,"main-container"],[1,"sidebar-section"],[1,"content-grid"],[3,"psychologistId"]],template:function(t,o){t&1&&(b(0,"div",0)(1,"div",1),p(2,"app-sidebar-client"),h(),b(3,"div",2)(4,"h2"),C(5,"Schedule Reservation"),h(),p(6,"app-reservation-calendar",3),h()()),t&2&&(A(6),u("psychologistId",o.psychologistId))},dependencies:[f,E],styles:[".main-container[_ngcontent-%COMP%]{display:flex;height:100vh}.sidebar-section[_ngcontent-%COMP%]{width:250px;flex-shrink:0}.content-grid[_ngcontent-%COMP%]{flex-grow:1;padding:20px;overflow-y:auto}"]})};export{U as ScheduleReservationComponent};
